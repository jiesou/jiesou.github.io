<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/favicon.ico"><link rel="icon" href="/favicon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="Jiecs"><meta name="keywords" content=""><meta name="description" content="前言ShellCrash 按设计能够在各种基于&#x2F;类似 OpenWrt 的系统上方便地配置管理 mihomo、singbox 之类的代理内核。但由于 Merlin（梅林）固件的许多组件都有自己的实现，ShellCrash 在 Merlin 上运行可能遇到各种各样的问题。 这篇指南包含对 iptables、ShellCrash、Dnsmasq 运作方式的说明，使用了很多强制覆写之类的 hac"><meta property="og:type" content="article"><meta property="og:title" content="梅林固件与 ShellCrash 的冲突 - 关于 iptables 与 Dnsmasq"><meta property="og:url" content="https://www.jiecs.top/archives/6b93c6c3/index.html"><meta property="og:site_name" content="杰出兽的小宇宙"><meta property="og:description" content="前言ShellCrash 按设计能够在各种基于&#x2F;类似 OpenWrt 的系统上方便地配置管理 mihomo、singbox 之类的代理内核。但由于 Merlin（梅林）固件的许多组件都有自己的实现，ShellCrash 在 Merlin 上运行可能遇到各种各样的问题。 这篇指南包含对 iptables、ShellCrash、Dnsmasq 运作方式的说明，使用了很多强制覆写之类的 hac"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jiecs.top/img/2024/08/cover_%E6%A2%85%E6%9E%97%E5%9B%BA%E4%BB%B6%E4%B8%8E_ShellCrash_%E7%9A%84%E5%86%B2%E7%AA%81%E5%85%B3%E4%BA%8E_iptables_%E4%B8%8E_Dnsmasq.webp"><meta property="article:published_time" content="2024-08-04T22:32:01.000Z"><meta property="article:modified_time" content="2025-10-23T08:27:50.429Z"><meta property="article:author" content="Jiecs"><meta property="article:tag" content="日常"><meta property="article:tag" content="技术"><meta property="article:tag" content="教程"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://cdn.jiecs.top/img/2024/08/cover_%E6%A2%85%E6%9E%97%E5%9B%BA%E4%BB%B6%E4%B8%8E_ShellCrash_%E7%9A%84%E5%86%B2%E7%AA%81%E5%85%B3%E4%BA%8E_iptables_%E4%B8%8E_Dnsmasq.webp"><title>梅林固件与 ShellCrash 的冲突 - 关于 iptables 与 Dnsmasq - 杰出兽的小宇宙</title><link rel="stylesheet" href="https://unpkg.jiecs.top/bootstrap@4.6.1/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://unpkg.jiecs.top/hint.css@2.7.0/hint.min.css"><link rel="stylesheet" href="https://unpkg.jiecs.top/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"www.jiecs.top",root:"/",version:"1.9.8",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:["home"]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!1,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:1},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:null,google:{measurement_id:null},tencent:{sid:null,cid:null},leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1},umami:{src:null,website_id:null,domains:null,start_time:"2024-01-01T00:00:00.000Z",token:null,api_server:null}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 7.3.0"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"></head><body><style>footer{position:relative}.iframe-overlay,iframe[loading=lazy]{position:absolute;height:245px;width:300px;transform:scale(.9) translateY(-120px) translateX(25px);clip-path:inset(0 round 1.2rem);bottom:-80px;left:0;z-index:3;transition:transform .3s ease,clip-path .3s ease}.iframe-overlay{z-index:4;background:0 0;cursor:pointer;display:none}iframe[loading=lazy].expanded+.iframe-overlay{display:none}iframe[loading=lazy].expanded{transform:scale(1) scaleY(1) translateY(-120px) translateX(25px);clip-path:inset(0 0 0 0 round 1.2rem)}:root[data-user-color-scheme=light] iframe[loading=lazy]{filter:invert(1) hue-rotate(-200deg)}@media (max-width:1700px){.iframe-overlay,iframe[loading=lazy]{clip-path:inset(0 0 120px 0 round 1.2rem);transform:scale(.64)}iframe[loading=lazy]:hover{transform:scale(1) scaleY(1) translateY(-120px) translateX(25px);clip-path:inset(0 round 1.2rem)}.iframe-overlay{display:block}}@media (max-width:768px){.iframe-overlay,iframe[loading=lazy]{clip-path:inset(0 0 163px 0 round 1.2rem);bottom:-25px;transform:scale(.5) scaleY(.93);left:calc(50% - 150px)}iframe[loading=lazy]:hover{transform:scale(1) scaleY(1) translateY(-120px) translateX(0);clip-path:inset(0 0 0 0 round 1.2rem)}iframe[loading=lazy].expanded{transform:scale(.8) scaleY(1) translateY(-120px) translateX(0);clip-path:inset(0 0 0 0 round 1.2rem)}}</style><script>document.addEventListener("DOMContentLoaded",(function(){const e=document.querySelector("footer"),t=document.createElement("iframe");t.frameBorder=0,t.src="https://support.nodeget.com/page/promotion?id=334%20|%20jiesou",t.loading="lazy";const n=document.createElement("div");n.className="iframe-overlay",n.addEventListener("click",(function(e){e.preventDefault(),e.stopPropagation(),t.classList.add("expanded")})),e.appendChild(t),e.appendChild(n),document.addEventListener("click",(function(e){t.contains(e.target)||t.classList.remove("expanded")}))}))</script><header><div class="header-inner" style="height:60vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>杰出兽的小宇宙</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/%E5%8A%A8%E6%80%81/" target="_self"><i class="iconfont icon-comment"></i> <span>动态</span></a></li><li class="nav-item"><a class="nav-link" href="/projects/" target="_self"><i class="iconfont icon-code"></i> <span>项目</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-link-fill"></i> <span>友链</span></a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="https://www.alongw.cn" target="_self"><span>阿龙博客</span></a></div></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" false style="background:url(https://cdn.jiecs.top/img/2024/08/cover_%E6%A2%85%E6%9E%97%E5%9B%BA%E4%BB%B6%E4%B8%8E_ShellCrash_%E7%9A%84%E5%86%B2%E7%AA%81%E5%85%B3%E4%BA%8E_iptables_%E4%B8%8E_Dnsmasq.webp) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle">梅林固件与 ShellCrash 的冲突 - 关于 iptables 与 Dnsmasq</span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2024-08-04 22:32" pubdate>2024年8月4日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 3.7k 字</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">梅林固件与 ShellCrash 的冲突 - 关于 iptables 与 Dnsmasq</h1><div class="markdown-body"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>ShellCrash 按设计能够在各种基于&#x2F;类似 OpenWrt 的系统上方便地配置管理 mihomo、singbox 之类的代理内核。但由于 Merlin（梅林）固件的许多组件都有自己的实现，ShellCrash 在 Merlin 上运行可能遇到各种各样的问题。</p><p>这篇指南包含对 iptables、ShellCrash、Dnsmasq 运作方式的说明，使用了很多强制覆写之类的 hack，如果你也遇到了各种奇奇怪怪的问题，希望可以提供一些参考</p><p>这篇指南应该也同样适用于 OpenClash 之类的程序，由于 Merlin 固件可能因更新导致部分特性变化，所以注意本指南特别适用于 Merlin 3004.388.8 (388.8) 版本以及 ShellCrash 1.9.0release 版本，ShellCrash 升级到 beta 后部分功能可能有改善，但也有更多不兼容（截止 1.9.1beta13）。本指南下，路由器 IP 为 192.168.50.1，如果没改过网段，这也是默认值</p><h2 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h2><p>ShellCrash 默认的 DNS 配置是很够用的，然而你如果发现无论怎么配置，用 <a target="_blank" rel="noopener" href="https://ipleak.net/">https://ipleak.net</a> 或 <a target="_blank" rel="noopener" href="https://browserleaks.com/dns">https://browserleaks.com/dns</a> 之类的网站仍能找到运营商 DNS 泄露，或者间歇性的泄露话，那很可能不是你 <strong>内核</strong> DNS 配置的问题，而是 ShellCrash 没能正确将所有 DNS 请求劫持到 <strong>内核</strong> 中</p><div class="note note-light"><p>内核 DNS 配置无误的情况下，除了 ShellCrash 对 DNS 请求劫持不完善可能导致问题，问题也有可能是 Windows 智能多宿主名称解析（Link-Local Multicast Name Resolution）导致的，此种情况可以自行搜索解决，不在这篇指南的讨论范围内</p></div><h3 id="确认问题"><a href="#确认问题" class="headerlink" title="确认问题"></a>确认问题</h3><p>如果你没修改端口，那 ShellCrash 默认会让内核 DNS 监听 <strong>1053</strong> 端口，也会通过 iptables 将 53 端口转发至 1053</p><p>你可以在设备上尝试运行 <code>dig google.com @192.168.50.1</code> 和 <code>dig google.com @192.168.50.1 -p 1053</code>。如果后者能得到正确的 IP（或 fakeip），而前者只能得到国内污染后的 IP，那就说明 ShellCrash 对 DNS 请求的劫持存在问题，需要自己重新定向 DNS</p><h3 id="Merlin-中的-DNS"><a href="#Merlin-中的-DNS" class="headerlink" title="Merlin 中的 DNS"></a>Merlin 中的 DNS</h3><p>而 Merlin 有许多处地方可以配置 DNS，配置及其复杂，说明又不甚清晰，这里就我的理解说明一下</p><h4 id="LAN-DNS-Director"><a href="#LAN-DNS-Director" class="headerlink" title="LAN - DNS Director"></a>LAN - DNS Director</h4><p>这是华硕&#x2F;Trend Micro 自己实现的优先级最高的 DNS 重定向工具，主要用于 <em>家长控制</em> 类功能，通常不应该用 DNS Director 设置 DNS</p><div class="note note-light"><p>根据<a target="_blank" rel="noopener" href="https://github.com/RMerl/asuswrt-merlin.ng/wiki/DNS-Director"><em>文档</em></a>，在较老的 Merlin 固件中，DNS Director 叫做 DNSFilter</p></div><h4 id="LAN-DHCP-服务器-DNS-及-WINS-服务器设置"><a href="#LAN-DHCP-服务器-DNS-及-WINS-服务器设置" class="headerlink" title="LAN - DHCP 服务器 - DNS 及 WINS 服务器设置"></a>LAN - DHCP 服务器 - DNS 及 WINS 服务器设置</h4><p>此处配置的 DNS 只是在分配 IP 的时候指定，默认就是 192.168.50.1，交由路由器处理，同时也可配置“Advertise router’s IP in addition to user-specified DNS”，即 在用户指定的 DNS 之外，还附上路由器的 IP。通常全部交给路由器处理即可</p><h4 id="WAN-互联网-DNS-设置"><a href="#WAN-互联网-DNS-设置" class="headerlink" title="WAN - 互联网 DNS 设置"></a>WAN - 互联网 DNS 设置</h4><p>此处配置的 DNS 是 <strong>路由器本身 Dnsmasq</strong> 的 DNS 配置，即关于 192.168.50.1:53 的配置，默认自动使用运营商 DNS。会影响路由器自己的网络，如果设备将 DNS 请求交给路由器（如 DHCP 分配路由器 IP 作为 DNS 服务器的情况下），也会影响连接到该路由器的设备</p><p>Merlin 内置 Dnsmasq 用于处理 DNS，Dnsmasq 的配置位于 <code>/etc/dnsmasq.conf</code>，其中引用了 <code>servers-file=/tmp/resolv.dnsmasq</code> ，而 WAN 处的 DNS 配置就正对应了 <code>/tmp/resolv.conf</code> 的内容</p><div class="note note-light"><p>根据<a target="_blank" rel="noopener" href="https://github.com/RMerl/asuswrt-merlin.ng/wiki/Custom-domains-with-dnsmasq"><em>文档</em></a>，你可以通过 <code>/jffs/configs/dnsmasq.conf.add</code> 在 Dnsmasq 配置末尾添加新配置。但这种方式不适用于解决 DNS 泄露问题，因为 Dnsmasq 会并发所有 DNS 服务器，即使配置为 <code>strict-order</code> 也会因所添加的配置在配置末尾，导致顺序上不优先使用设定的 DNS 服务器</p></div><h3 id="开始操作"><a href="#开始操作" class="headerlink" title="开始操作"></a>开始操作</h3><p>管理面板中以上三处都能改 DNS，然而都被限制不能自定义 DNS 服务器的端口。内核监听的是 1053 端口，肯定需要自定义端口，所以我们要自己覆写 Dnsmasq 配置：</p><ol><li>在开始之前，为防止与我们自己的 DNS 处理冲突，你要在 crash 菜单的 7-6-7 处（新版可能变化）禁用 ShellCrash 自己的 DNS 劫持</li><li>我们要修改的是 <code>/tmp/resolv.dnsmasq</code> 的配置，可以先确认一下这个配置的内容，用 <code>cp /tmp/resolv.dnsmasq /tmp/resolv.dnsmasq.bak</code> 备份原始配置</li><li>然后运行 <code>echo &quot;server=192.168.50.1#1053&quot; &gt; /tmp/resolv.dnsmasq</code> 覆写原配置。用 # 表示端口</li><li>用 <code>service restart_dnsmasq</code> 重启 Dnsmasq 服务</li></ol><h4 id="User-script-防覆盖"><a href="#User-script-防覆盖" class="headerlink" title="User script 防覆盖"></a>User script 防覆盖</h4><p>为防止配置重新被 Merlin 改写回去，你可以通过 Merlin 的 <a target="_blank" rel="noopener" href="https://github.com/RMerl/asuswrt-merlin.ng/wiki/User-scripts">User script</a> 功能在路由器启动后自动覆写配置</p><p>比如，你可以创建 <code>/jffs/scripts/override-dnsmasq.sh</code> 并粘贴上</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">执行 Dnsmasq 复写</span><br>cp /tmp/resolv.dnsmasq /tmp/resolv.dnsmasq.bak # 备份原始<br>echo &quot;server=192.168.50.1#1053&quot; &gt; /tmp/resolv.dnsmasq<br>service restart_dnsmasq<br></code></pre></td></tr></table></figure><div class="note note-light"><p>可以自己试运行一下。注意还要 <code>chmod +x /jffs/scripts/override-dnsmasq.sh</code> 为 .sh 文件添加执行权限</p></div><p>然后在 <code>/jffs/scripts/nat-start</code> 或其他 User script Hook 点（大多数都可以）中添加 <code>sh /jffs/scripts/override-dnsmasq.sh</code> 来自动执行这个脚本</p><div class="note note-light"><p>ShellCrash 默认也是在 nat-start 处初始化 ShellCrash 的，添加后 nat-start 看起来应该像这样：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">/jffs/ShellCrash/start.sh init #ShellCrash初始化脚本<br><br>sh /jffs/scripts/start-services.sh<br></code></pre></td></tr></table></figure></div><h3 id="完成"><a href="#完成" class="headerlink" title="完成"></a>完成</h3><p>DNS 配置完成了🎉</p><p>回到 <a href="#%E7%A1%AE%E8%AE%A4%E9%97%AE%E9%A2%98">确认问题</a> 并用 <a target="_blank" rel="noopener" href="https://ipleak.net/">https://ipleak.net</a> 或 <a target="_blank" rel="noopener" href="https://browserleaks.com/dns">https://browserleaks.com/dns</a> 之类的网站来检查一下还有没有问题吧！</p><div class="note note-light"><p>如果你有对国内网站设置国内的 DNS，那还可以用网易的 <a target="_blank" rel="noopener" href="https://nstool.netease.com/">https://nstool.netease.com</a> 这个网站来检查你在国内使用的 DNS 服务器</p></div><h3 id="本机代理问题"><a href="#本机代理问题" class="headerlink" title="本机代理问题"></a>本机代理问题</h3><p>实际上，完成以上步骤之后，设备应当就已经能够正常上网了。然而，由于对 Dnsmasq 的配置，路由器本身（本机）进行 DNS 解析时也会通过内核的 <code>192.168.50.1#1053</code> DNS 进行，而如果你在使用 fakeip 模式，并没有配置本机代理的话，那便会导致 <strong>路由器自己</strong> 无法正常上网，因为路由器解析出的是 fakeip，而出站流量却不经过内核，那 fake 的 ip 肯定就连不上了</p><p>这个问题有两种解法：</p><ol><li>如果你希望本机也能代理，那需要让本机流量也走内核。但 ShellCrash 目前版本（1.9.0release）对本机代理的支持并不很好，只支持以“环境变量”的方式代理。你当然可以尝试自己用 iptables 在 OUTPUT 链上设置规则，只是会比较折腾</li><li>如果你认为本机没必要代理，那可以只劫持本机自己的 DNS 请求，重定向到一个能正常解析出 <strong>真 IP</strong> 的 DNS 服务器。这种情况下，你需要执行这条命令来通过 iptables 设置劫持：</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">iptables -t nat -A OUTPUT -p udp --dport 53 -d 192.168.50.1 -j DNAT --to-destination 8.8.8.8<br></code></pre></td></tr></table></figure><p>这个命令会在 nat 表的 OUTPUT 链中要求 NAT 将向 <code>192.168.50.1:53</code> 请求的目标地址转换为 <code>8.8.8.8(:53)</code></p><p>由于这个规则在 OUTPUT 链上，所以它不会影响到连接路由器的其他设备，而只影响路由器本机，详细原理可参考以下 <a href="#iptables-%E8%BF%90%E4%BD%9C%E6%96%B9%E5%BC%8F">iptables 运作方式</a></p><p>当然你也可以像<a href="#user-script-%E9%98%B2%E8%A6%86%E7%9B%96">上面</a>一样把这个命令添加到 User script 的 <code>firewall-start</code> Hook 点上，可以使用这个脚本避免规则被重复添加</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">重定向路由器 DNS</span><br>DNS_RULE=&quot;OUTPUT -p udp --dport 53 -d 192.168.50.1 -j DNAT --to-destination 8.8.8.8&quot;<br><br>if ! iptables -t nat -C $DNS_RULE 2&gt;/dev/null; then<br>    iptables -t nat -A $DNS_RULE<br>fi<br></code></pre></td></tr></table></figure><p>其中 <code>-C</code> flag 即用于确认该规则是否存在， <code>2&gt;/dev/null</code> 用于处理错误输出（规则不存在即报错）</p><h2 id="防火墙"><a href="#防火墙" class="headerlink" title="防火墙"></a>防火墙</h2><p>除了 DNS 问题，Merlin 自带的防火墙配置，尤其是 防火墙 - <strong>IPv6 防火墙</strong> 也会与 ShellCrash 对 IPv6 的流量劫持产生冲突</p><h3 id="确认问题-1"><a href="#确认问题-1" class="headerlink" title="确认问题"></a>确认问题</h3><p>实际上解决这个问题最简单的方式就是取消勾选 <code>启动 IPv6 防火墙</code>。如果关闭 IPv6 防火墙 后网络不存在问题，那便可以确定问题就出在这里</p><p>当然关闭整个 IPv6 防火墙肯定是存在安全风险的，Merlin 内建的防火墙其实基于一条条 iptables 规则，IPv6 防火墙则基于 <strong>ip6tables</strong> ，最好是搞清楚防火墙的运作原理，并自己正确配置它们</p><h3 id="iptables-运作方式"><a href="#iptables-运作方式" class="headerlink" title="iptables 运作方式"></a>iptables 运作方式</h3><p>iptables 内建于 Merlin 固件中，用于控制数据包的处理和转发，你可以在它各个 <strong>表</strong> 的各个 <strong>链</strong> 上设置规则</p><pre>
<code class="mermaid">
flowchart BT
    subgraph 网络层输入
        in(["输入"]) --> PREROUTING
        PREROUTING --> routing(["路由决策"])
    end

    subgraph 本机
        routing(["路由决策"]) --> INPUT
        INPUT --> local(("本机（ShellCrash）"))
        local(("本机（ShellCrash）")) --> OUTPUT
    end

    subgraph 转发处理
        routing(["路由决策"]) --> FORWARD
    end

    subgraph 网络层输出
        FORWARD --> POSTROUTING
        OUTPUT --> POSTROUTING
        POSTROUTING --> out(["输出"])
    end

    style 本机 fill:#f9f,stroke:#333,stroke-width:2px
    style 转发处理 fill:#bbf,stroke:#333,stroke-width:2px
    style 网络层输入 fill:#ff9,stroke:#333,stroke-width:2px
    style 网络层输出 fill:#ff9,stroke:#333,stroke-width:2px
</code>
</pre><p>这个流程图中的 方框 如 <code>PREROUTING</code> 、 <code>FORWARD</code> 即属于不同 <strong>表</strong> 中的 <strong>链</strong></p><p>主要有四张表：</p><ul><li>filter</li><li>mangle</li><li>nat</li><li>raw</li></ul><p>五条链：</p><ul><li>PREROUTING</li><li>FORWARD</li><li>INPUT</li><li>OUTPUT</li><li>POSTROUTING</li></ul><p>即常说的“四表五链”</p><p>当然也可能有其他各种表和链，比如 <code>security</code> 表，还有 ShellCrash 会在 mangle 表创建的 <code>shellcrashv6</code> 链，但我们通常不用动那些表和链</p><h4 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h4><p>比如，你可以通过 <code>ip6tables -t filter -nvL INPUT</code> 查看 filter 表中 INPUT 链上的规则，规则从上往下按顺序匹配</p><p>其中：</p><ul><li>t [map] 用于指定要查哪张表，实际上不填默认就是 <code>filter</code> 表</li><li>n 表示不对 ip 进行域名解析，让返回快很多</li><li>v 表示更多信息，比如 <code>pkts</code> 和 <code>bytes</code> 列</li><li>L 表示列出规则</li></ul><p>你还可以用 <code>ip6tables-save</code> 查看现有的所有表，并得到 <strong>可以作为命令来添加执行</strong> 的格式</p><p>ShellCrash 也是靠 iptables <strong>劫持流量</strong> 的。以 tproxy 模式举例，ShellCrash 会在 PREROUTING 中通过 tproxy（透明代理）和路由表将本该通过 FORWARD 到公网的流量， <strong>重定向到本机的 INPUT</strong> ，并在 mihomo&#x2F;sing-box 内核中处理流量</p><p>由于 PREROUTING 链位于 mangle 表，所以你可以通过<code>ip6tables -t mangle -nvL</code> 查看整个 mangle 表的内容，其中包括了 ShellCrash 在 PREROUTING 链设置的规则，也包括了它自己创建的 <code>shellcrashv6</code> 链。输出应该形似这样：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs shell">Chain PREROUTING (policy ACCEPT 1843K packets, 2274M bytes)<br> pkts bytes target     prot opt in     out     source               destination         <br>2176K 2300M shellcrashv6  tcp      *      *       ::/0                 ::/0                <br> 107K   54M shellcrashv6  udp      *      *       ::/0                 ::/0                <br><br>Chain INPUT (policy ACCEPT 2294K packets, 2355M bytes)<br> pkts bytes target     prot opt in     out     source               destination         <br><br>Chain FORWARD (policy ACCEPT 40213 packets, 3977K bytes)<br> pkts bytes target     prot opt in     out     source               destination         <br><br>Chain OUTPUT (policy ACCEPT 1694K packets, 2232M bytes)<br> pkts bytes target     prot opt in     out     source               destination         <br><br>Chain POSTROUTING (policy ACCEPT 1739K packets, 2236M bytes)<br> pkts bytes target     prot opt in     out     source               destination         <br><br>Chain shellcrashv6 (2 references)<br> pkts bytes target     prot opt in     out     source               destination         <br>22957 1991K RETURN     udp      *      *       ::/0                 ::/0                 udp dpt:53<br> 6309  460K RETURN     all      *      *       ::/0                 240x:xxxx:xxxx:xxxx::/64 <br>1748K 2264M RETURN     all      *      *       ::/0                 240x:xxxx:xxxx:xxxx::/64 <br>    0     0 RETURN     all      *      *       ::/0                 ::/128              <br>    0     0 RETURN     all      *      *       ::/0                 ::1/128             <br>    0     0 RETURN     all      *      *       ::/0                 ::ffff:0.0.0.0/96   <br>   13  1040 RETURN     all      *      *       ::/0                 64:ff9b::/96        <br>    0     0 RETURN     all      *      *       ::/0                 100::/64            <br> 1360 97998 RETURN     all      *      *       ::/0                 2001::/32           <br>    0     0 RETURN     all      *      *       ::/0                 2001:20::/28        <br>    0     0 RETURN     all      *      *       ::/0                 2001:db8::/32       <br>   41  4670 RETURN     all      *      *       ::/0                 2002::/16           <br> 4400  348K RETURN     all      *      *       ::/0                 fc00::/7            <br>   25  4350 RETURN     all      *      *       ::/0                 fe80::/10           <br> 5737 1554K RETURN     all      *      *       ::/0                 ff00::/8            <br> 463K   79M TPROXY     tcp      *      *       240x:xxxx:xxxx:xxxx::/64  ::/0                 TPROXY redirect :::7893 mark 0x1ed4/0xffffffff<br>    0     0 TPROXY     tcp      *      *       240x:xxxx:xxxx:xxxx::/64  ::/0                 TPROXY redirect :::7893 mark 0x1ed4/0xffffffff<br>32340 6248K TPROXY     udp      *      *       240x:xxxx:xxxx:xxxx::/64  ::/0                 TPROXY redirect :::7893 mark 0x1ed4/0xffffffff<br>    0     0 TPROXY     udp      *      *       240x:xxxx:xxxx:xxxx::/64  ::/0                 TPROXY redirect :::7893 mark 0x1ed4/0xffffffff<br></code></pre></td></tr></table></figure><p>表的内容都很好理解。其中：</p><ul><li><code>pkts</code> 指通过这条规则的包数</li><li><code>bytes</code> 指通过这条规则的字节数</li></ul><p>可以用来确定规则有没有在正常工作</p><h3 id="Merlin-中的防火墙"><a href="#Merlin-中的防火墙" class="headerlink" title="Merlin 中的防火墙"></a>Merlin 中的防火墙</h3><p><img src="https://cdn.jiecs.top/img/2024/08/1000013046.webp" srcset="/img/loading.gif" lazyload alt="FORWARD diff"></p><p><img src="https://cdn.jiecs.top/img/2024/08/1000013045.webp" srcset="/img/loading.gif" lazyload alt="INPUT diff"></p><p>通过对比关闭和开启 IPv6 防火墙的 ip6tables 规则，可以注意到：</p><ul><li>在 FORWARD 链，多了根据面板设置的端口白名单（ACCEPT）。同时顶部的 policy（即默认策略），从 ACCEPT 变成了 DROP（即丢弃）</li><li>在 INPUT 链，最下面多了一条全部 DROP 的规则</li></ul><p>相当于</p><pre>
<code class="mermaid">
flowchart BT
    subgraph 网络层输入
        in(["输入"]) --> PREROUTING
        PREROUTING --> routing(["路由决策"])
    end

    subgraph 本机
        routing(["路由决策"])  --x |"DROP"| INPUT
        INPUT --> local(("本机"))
        local(("本机（ShellCrash）")) --> OUTPUT
    end

    subgraph 转发处理
        routing(["路由决策"])  --x |"非白名单就 DROP"| FORWARD
    end

    subgraph 网络层输出
        FORWARD --> POSTROUTING
        OUTPUT --> POSTROUTING
        POSTROUTING --> out(["输出"])
    end

    style 本机 fill:#f9f,stroke:#333,stroke-width:2px
    style 转发处理 fill:#bbf,stroke:#333,stroke-width:2px
    style 网络层输入 fill:#ff9,stroke:#333,stroke-width:2px
    style 网络层输出 fill:#ff9,stroke:#333,stroke-width:2px
    linkStyle 5 stroke:red
    linkStyle 2 stroke:red
</code>
</pre><p>FORWARD 链对 ShellCrash 应当没有影响</p><p>但参照<a href="#%E5%91%BD%E4%BB%A4%E8%A1%8C">此处</a>对 ShellCrash 原理的说明，ShellCrash 劫持的流量肯定要 <strong>经过 INPUT</strong> ，到本机的内核里去处理。而本机的 INPUT 入站始终被 DROP，自然便无法正常使用 IPv6 了</p><h3 id="开始操作-1"><a href="#开始操作-1" class="headerlink" title="开始操作"></a>开始操作</h3><p>要解决这一问题，自然就是要让 ShellCrash 劫持的流量不被 DROP 掉。从问题出发，主要有两种办法</p><h4 id="方法一：在-DROP-规则的上面插入-ACCEPT-规则"><a href="#方法一：在-DROP-规则的上面插入-ACCEPT-规则" class="headerlink" title="方法一：在 DROP 规则的上面插入 ACCEPT 规则"></a>方法一：在 DROP 规则的上面插入 ACCEPT 规则</h4><p>用 <code>ip6tables -I INPUT 1 -i ppp0 -j ACCEPT</code> 在 INPUT 链的首位插入”对所有来自 ppp0 网络接口（IPv6）的流量都 ACCEPT”规则</p><p>其中</p><ul><li><code>-I [Chain] 1</code> 即表示在指定链的第 1 位插入规则</li></ul><h4 id="方法二：删去原本的-DROP-规则"><a href="#方法二：删去原本的-DROP-规则" class="headerlink" title="方法二：删去原本的 DROP 规则"></a>方法二：删去原本的 DROP 规则</h4><p>用 <code>ip6tables -D INPUT -j DROP</code> 直接删掉那条 DROP 规则</p><p>其中</p><ul><li><code>-D [Chain]</code> 即表示在指定链中删除规则</li></ul><p>两种方法都可以，也同样需要把这个命令添加到 User script 的 <code>firewall-start</code> Hook 点上，参照<a href="#user-script-%E9%98%B2%E8%A6%86%E7%9B%96">上文</a></p><h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>如果你在折腾的过程中遇到了很奇怪的问题，可以用这些小工具小技巧方便调试、透析流量</p><h3 id="Entware"><a href="#Entware" class="headerlink" title="Entware"></a>Entware</h3><p><a target="_blank" rel="noopener" href="https://github.com/Entware/Entware">Entware</a> 是一个强大的适用于嵌入式的包管理器，即使路由器固件不是 OpenWrt，也可使用 <code>opkg</code> 之类的命令</p><p>Merlin 固件内建了 <em>amtm - the Asuswrt-Merlin Terminal Menu</em> ，方便你在 Merlin 上安装 Entware 之类的程序</p><ol><li>运行 <code>amtm</code>打开 amtm，第一次打开可能要求配置主题，可以直接选第一个</li><li>在 amtm 中，输入 <code>i</code> 可查看所有可用的程序，参照指示输入 <code>ep</code> 即可在一个 U 盘上安装 entware</li></ol><p>事实上 Merlin 内建的 SSH 服务端是不支持 SFTP 的，而有了 Entware，你便可以直接输入 <code>opkg install openssh-sftp-server</code> 来安装 sftp。不需要任何配置，也不用折腾 FTP 之类的，随便找一个 SFTP 的客户端即可轻松管理路由器中的文件系统</p><h3 id="用-Wireshark-在路由器上抓包"><a href="#用-Wireshark-在路由器上抓包" class="headerlink" title="用 Wireshark 在路由器上抓包"></a>用 Wireshark 在路由器上抓包</h3><p>Wireshark 作为很强大的抓包工具，支持通过 SSH 连接远程设备并通过 tcpdump&#x2F;dumpcap 抓取流量。自然也可以连接到路由器的 SSH 上抓包</p><ol><li>Merlin 固件并不内建 tcpdump，参照<a href="#entware">以上</a>说明安装 Entware 之后，你便也可以通过 <code>opkg</code> 安装来安装 tcpdump</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">opkg install tcpdump<br></code></pre></td></tr></table></figure><ol start="2"><li>打开 Wireshark 客户端，打开 <code>捕获 - 选项</code></li></ol><p><img src="https://cdn.jiecs.top/img/2024/08/1000013055.webp" srcset="/img/loading.gif" lazyload alt="Wireshark 首页"></p><ol start="3"><li>选中 <code>SSH remote capture:sshdump</code>，点击它的设置</li></ol><p><img src="https://cdn.jiecs.top/img/2024/08/1000013056.webp" srcset="/img/loading.gif" lazyload alt="捕获选项"></p><ol start="4"><li>在 Server 和 Authentication 页配置路由器的 SSH 连接信息，并在 Capture 页中设置 Remote interface 和 Remote capture filter</li></ol><p><img src="https://cdn.jiecs.top/img/2024/08/1000013057.webp" srcset="/img/loading.gif" lazyload alt="接口选项"></p><p>Remote interface 即所抓包的网络接口，主要可以为：</p><ul><li>ppp0 即 IPv6 的接口</li><li>br0 即内网接口</li></ul><p>可以通过 <code>ip a</code> 查看所有可用的网络接口和对应的 IP</p><p>Remote capture filter 是总的过滤器，建议用 <code>not port [SSH_PORT]</code> 过滤掉 Wireshark 客户端自己抓包的 SSH 数据</p><ol start="5"><li>然后就可以关掉设置开始抓包了</li></ol><h3 id="用-iptables-LOG"><a href="#用-iptables-LOG" class="headerlink" title="用 iptables LOG"></a>用 iptables LOG</h3><p>iptables 不仅可以设置 ACCEPT、DROP 之类的规则，还可以设置 jump 到 LOG</p><p>例如 <code>ip6tables -I INPUT 1 -i ppp0 -m limit --limit 60/min -j LOG --log-prefix &quot;FROM-PPP0: &quot;</code> 即可将所有符合该规则（从 ppp0 接口进入）的流量记录到日志中</p><p>其中：</p><ul><li><code>-m limit --limit 60/min</code> 用于限制记录日志的频率，包太多路由器很容易卡死</li><li><code>--log-prefix [str]</code> 即日志前缀</li></ul><div class="note note-light"><p>注意 iptables 规则从上往下匹配，用 <code>-A</code> 来添加会把 LOG 规则放在链的最后，如果数据在前面就已经被 DROP 了那就不会记录下来。所以这里用 <code>-I [Chain] 1</code> 指定插入到链的第 1 位</p></div><p>可以通过 <code>dmesg | grep &quot;FROM-PPP0: &quot;</code> 来查找记录下来的流量，grep 即用于查找 log 前缀</p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E7%AE%80%E5%8D%95%E6%8A%80%E6%9C%AF/" class="category-chain-item">简单技术</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/%E6%97%A5%E5%B8%B8/" class="print-no-link">#日常</a> <a href="/tags/%E6%8A%80%E6%9C%AF/" class="print-no-link">#技术</a> <a href="/tags/%E6%95%99%E7%A8%8B/" class="print-no-link">#教程</a></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/archives/e023069a/" title="各种连接器总结"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">各种连接器总结</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/archives/90ab79b3/" title="Azure 中通过负载均衡器零成本开启 IPv6 支持"><span class="hidden-mobile">Azure 中通过负载均衡器零成本开启 IPv6 支持</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><script>Fluid.utils.createScript("https://unpkg.jiecs.top/mermaid@8.14.0/dist/mermaid.min.js",(function(){mermaid.initialize({theme:"default"}),Fluid.utils.listenDOMLoaded((function(){Fluid.events.registerRefreshCallback((function(){"mermaid"in window&&mermaid.init()}))}))}))</script><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="/follow" target="_blank" rel="nofollow noopener"><span>Follow</span></a> | <a href="/thanks" target="_blank" rel="nofollow noopener"><span>Thanks</span></a> | <a href="/privacy-policy" target="_blank" rel="nofollow noopener"><span>Privacy</span></a> | <a href="https://jiecs-status.betteruptime.com" target="_blank" rel="nofollow noopener"><span>Status</span></a><br>Jiecs All Rights Reserved</div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">浙ICP备2021024503号</a></span></div></div></footer><script src="https://unpkg.jiecs.top/jquery@3.6.4/dist/jquery.min.js"></script><script src="https://unpkg.jiecs.top/bootstrap@4.6.1/dist/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://unpkg.jiecs.top/tocbot@4.20.1/dist/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://unpkg.jiecs.top/clipboard@2.0.11/dist/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://unpkg.jiecs.top/anchor-js@5.0.0/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://unpkg.jiecs.top/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript><script src="/js/resize_image.js"></script><link rel="stylesheet" href="https://unpkg.jiecs.top/@waline/client@3.6.0/dist/waline.css"><link rel="stylesheet" href="/css/post_custom.css"><script src="https://unpkg.jiecs.top/@waline/client@3.6.0/dist/waline.umd.js"></script><script src="/js/post_custom.js"></script><script>if(!/jiecs.top|localhost/.test(location.host)){/google|bing|baidu|sogou|soso|DuckDuckBot|yandex|msn/i.test(navigator.userAgent)&&(location.host="www.jiecs.top")}</script><script defer async>if(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack||"",dnt.startsWith("1")||dnt.startsWith("yes")||dnt.startsWith("on")){var footer=document.querySelector("div.footer-content");footer.innerHTML=footer.innerHTML+"<br>I don't track ;)"}else{!function(t,e,a,n,o,r,c){t[a]=t[a]||function(){(t[a].q=t[a].q||[]).push(arguments)},(r=e.createElement(n)).async=1,r.src="https://www.clarity.ms/tag/83h7yd1jzh",(c=e.getElementsByTagName(n)[0]).parentNode.insertBefore(r,c)}(window,document,"clarity","script");var _hmt=_hmt||[];!function(){var t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?e2bcbf5019e3c05e7631d4a3081b10d9";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}();let t=document.createElement("script");function gtag(){dataLayer.push(arguments)}t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-8QKELED2GX",document.body.appendChild(t),window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-8QKELED2GX")}</script><script src="/js/custom.js"></script></body></html>