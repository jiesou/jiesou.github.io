<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/favicon.ico"><link rel="icon" href="/favicon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="Jiecs"><meta name="keywords" content=""><meta name="description" content="前言比起微信 QQ 那种毒瘤，Telegram 已是降维打击。然而现在 Telegram 也正变得越来越封闭，加入了频道广告还有 Telegram Premium，对免费用户的限制越来越多 最关键的是 Telegram 的开源开放程度也在一点点地降低，而且 Telegram 本身的端到端加密对话没法云同步，群聊频道都不支持，根本没想让你日常使用。Telegram 的服务器端并不开源，从技术上来说"><meta property="og:type" content="article"><meta property="og:title" content="别再用 Telegram 了！快换到真开源的 Martix — 搭建 mautrix-telegram 桥接"><meta property="og:url" content="https://www.jiecs.top/archives/2a3d3c6c/index.html"><meta property="og:site_name" content="杰出兽的小宇宙"><meta property="og:description" content="前言比起微信 QQ 那种毒瘤，Telegram 已是降维打击。然而现在 Telegram 也正变得越来越封闭，加入了频道广告还有 Telegram Premium，对免费用户的限制越来越多 最关键的是 Telegram 的开源开放程度也在一点点地降低，而且 Telegram 本身的端到端加密对话没法云同步，群聊频道都不支持，根本没想让你日常使用。Telegram 的服务器端并不开源，从技术上来说"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jiecs.top/img/2023/06/cover_%E5%88%AB%E5%86%8D%E7%94%A8Telegram%E4%BA%86%EF%BC%81%E5%BF%AB%E6%8D%A2%E5%88%B0%E7%9C%9F%E5%BC%80%E6%BA%90%E7%9A%84Martix.webp"><meta property="article:published_time" content="2023-06-23T11:06:02.000Z"><meta property="article:modified_time" content="2025-10-23T08:27:50.429Z"><meta property="article:author" content="Jiecs"><meta property="article:tag" content="教程"><meta property="article:tag" content="Telegram"><meta property="article:tag" content="Web3"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://cdn.jiecs.top/img/2023/06/cover_%E5%88%AB%E5%86%8D%E7%94%A8Telegram%E4%BA%86%EF%BC%81%E5%BF%AB%E6%8D%A2%E5%88%B0%E7%9C%9F%E5%BC%80%E6%BA%90%E7%9A%84Martix.webp"><title>别再用 Telegram 了！快换到真开源的 Martix — 搭建 mautrix-telegram 桥接 - 杰出兽的小宇宙</title><link rel="stylesheet" href="https://unpkg.jiecs.top/bootstrap@4.6.1/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://unpkg.jiecs.top/hint.css@2.7.0/hint.min.css"><link rel="stylesheet" href="https://unpkg.jiecs.top/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"www.jiecs.top",root:"/",version:"1.9.8",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:["home"]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!1,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:1},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:null,google:{measurement_id:null},tencent:{sid:null,cid:null},leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1},umami:{src:null,website_id:null,domains:null,start_time:"2024-01-01T00:00:00.000Z",token:null,api_server:null}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 7.3.0"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"></head><body><style>footer{position:relative}.iframe-overlay,iframe[loading=lazy]{position:absolute;height:245px;width:300px;transform:scale(.9) translateY(-120px) translateX(25px);clip-path:inset(0 round 1.2rem);bottom:-80px;left:0;z-index:3;transition:transform .3s ease,clip-path .3s ease}.iframe-overlay{z-index:4;background:0 0;cursor:pointer;display:none}iframe[loading=lazy].expanded+.iframe-overlay{display:none}iframe[loading=lazy].expanded{transform:scale(1) scaleY(1) translateY(-120px) translateX(25px);clip-path:inset(0 0 0 0 round 1.2rem)}:root[data-user-color-scheme=light] iframe[loading=lazy]{filter:invert(1) hue-rotate(-200deg)}@media (max-width:1700px){.iframe-overlay,iframe[loading=lazy]{clip-path:inset(0 0 120px 0 round 1.2rem);transform:scale(.64)}iframe[loading=lazy]:hover{transform:scale(1) scaleY(1) translateY(-120px) translateX(25px);clip-path:inset(0 round 1.2rem)}.iframe-overlay{display:block}}@media (max-width:768px){.iframe-overlay,iframe[loading=lazy]{clip-path:inset(0 0 163px 0 round 1.2rem);bottom:-25px;transform:scale(.5) scaleY(.93);left:calc(50% - 150px)}iframe[loading=lazy]:hover{transform:scale(1) scaleY(1) translateY(-120px) translateX(0);clip-path:inset(0 0 0 0 round 1.2rem)}iframe[loading=lazy].expanded{transform:scale(.8) scaleY(1) translateY(-120px) translateX(0);clip-path:inset(0 0 0 0 round 1.2rem)}}</style><script>document.addEventListener("DOMContentLoaded",(function(){const e=document.querySelector("footer"),t=document.createElement("iframe");t.frameBorder=0,t.src="https://support.nodeget.com/page/promotion?id=334%20|%20jiesou",t.loading="lazy";const n=document.createElement("div");n.className="iframe-overlay",n.addEventListener("click",(function(e){e.preventDefault(),e.stopPropagation(),t.classList.add("expanded")})),e.appendChild(t),e.appendChild(n),document.addEventListener("click",(function(e){t.contains(e.target)||t.classList.remove("expanded")}))}))</script><header><div class="header-inner" style="height:60vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>杰出兽的小宇宙</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/%E5%8A%A8%E6%80%81/" target="_self"><i class="iconfont icon-comment"></i> <span>动态</span></a></li><li class="nav-item"><a class="nav-link" href="/projects/" target="_self"><i class="iconfont icon-code"></i> <span>项目</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-link-fill"></i> <span>友链</span></a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="https://www.alongw.cn" target="_self"><span>阿龙博客</span></a></div></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" false style="background:url(https://cdn.jiecs.top/img/2023/06/cover_别再用Telegram了！快换到真开源的Martix.webp) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle">别再用 Telegram 了！快换到真开源的 Martix — 搭建 mautrix-telegram 桥接</span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-06-23 11:06" pubdate>2023年6月23日 上午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 2.5k 字</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">别再用 Telegram 了！快换到真开源的 Martix — 搭建 mautrix-telegram 桥接</h1><div class="markdown-body"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>比起微信 QQ 那种毒瘤，Telegram 已是降维打击。然而现在 Telegram 也正变得越来越封闭，加入了频道广告还有 Telegram Premium，对免费用户的限制越来越多</p><p>最关键的是 Telegram 的开源开放程度也在一点点地降低，而且 Telegram 本身的端到端加密对话没法云同步，群聊频道都不支持，根本没想让你日常使用。Telegram 的服务器端并不开源，从<em>技术上来说</em> Telegram 对用户的消息是有<strong>完全掌控权</strong>的，他们想干嘛都可以，与微信 QQ 没有本质区别</p><p>更何况 Telegram 客户端的开源程度有一点点的在降低，对三方客户端的限制越来越多。包括不能注册、限速下载以及严格的风控</p><p>这也正导致一些主打去中心化、开源开放的即时通讯软件&#x2F;协议越来越活跃起来。Matrix 就是相对知名且功能完善的</p><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><a target="_blank" rel="noopener" href="https://matrix.org/">Matrix</a> 本身只是一种去中心化的通讯协议，逻辑类似电子邮箱</p><p>电子邮箱中你可以选择不同的服务商：Gmail、QQ邮箱，而在 Matrix 中你也可以选不同的 Homeserver。比如一个形似 <code>@chen_this:matrix.org</code> 的用户名中，<code>:</code> 后的域名就表示这个用户所属的 Homeserver</p><p>就像电子邮箱中一样，<strong>不同 Homeserver</strong> 之间的消息也可以<strong>互通</strong>，而且每个 Homeserver 提供商都可以设置自己的规则，管理自己的用户。即使某个 Homeserver 宕机了，使用其他 Homeserver 的人也不会受到影响。而且协议本身也没法被墙之类的</p><p>同样，就像电子邮箱本身只是个协议，需要一个客户端，使用 Matrix 也<strong>要一个客户端</strong>。现在最为流行的就是 <a target="_blank" rel="noopener" href="https://element.io/">Element</a>（以前叫 Riot.im）。下载安装直接注册即可，注册 Matrix 账户不用手机号，通常需要电子邮箱，取决于 Homeserver 的设置</p><p>Matrix 对群聊对话的数量限制几乎没有，消息都是云同步，能发送贴纸表情、各种媒体，什么投票定位权限管理一应俱全。美中不足的是大多数 Homeserver 都只允许你上传单个最大 100M&#x2F;200M 的文件</p><h2 id="桥接"><a href="#桥接" class="headerlink" title="桥接"></a>桥接</h2><p>Matrix 还有一个特性就是能与其他即时通讯软件桥接。就像 Telegram 有 EH Forwarder Bot。然而 Telegram 的 EFB 确实问题挺多，经常动不动离线</p><p>Matrix 的各种 Bridges 能让你和 Telegram、Discord 甚至微信 QQ 桥接，直接在 Matrix 上收发其他平台的消息，而且体验相当无缝。这篇文章主要讲的就是 <a target="_blank" rel="noopener" href="https://github.com/mautrix/telegram">mautrix-telegram</a>，支持 Matrix - Telegram 双向映射，当然主要是 Telegram to Matrix</p><h3 id="预备条件"><a href="#预备条件" class="headerlink" title="预备条件"></a>预备条件</h3><ul><li>服务器</li><li>域名</li><li>域名的 SSL 证书</li></ul><p>不同于 Telegram 可以直接调用 Core API，由于 Matrix 的去中心化，要想在 Matrix 上和别人收发消息，你还<strong>需要搭建自己的 Homeserver</strong></p><p>当然 Homeserver 也可以在 Docker 中运行，但要搭建它你还需要一个域名。最好是二级域名而不是三级或以上（example.com 而不是 matrix.example.com）</p><p>还需要有这个域名的 SSL 证书，<a target="_blank" rel="noopener" href="https://certbot.eff.org/">certbot</a> 申请的 Let’s Encrypt 即可。安装 certbot 后运行 <code>sudo certbot certonly --standalone</code> 并根据说明操作</p><h3 id="Docker-Compose-部署"><a href="#Docker-Compose-部署" class="headerlink" title="Docker Compose 部署"></a>Docker Compose 部署</h3><p>整个桥以及配套环境都建议使用 <a target="_blank" rel="noopener" href="https://docs.docker.com/compose/">Docker Compose</a> 部署，一条命令就能开关，容器与外界隔离，不用担心依赖、兼容问题</p><h4 id="大体流程"><a href="#大体流程" class="headerlink" title="大体流程"></a>大体流程</h4><p>以下是我根据官方配置自己写的 docker-compose.yaml，把需要的服务都揉到了一起，供参考：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">synapse:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">docker.io/matrixdotorg/synapse:latest</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">SYNAPSE_CONFIG_PATH=/data/homeserver.yaml</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./synapse:/data</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/letsencrypt:/etc/cert:ro</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">db</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">8448</span><span class="hljs-string">:8448/tcp</span><br><br>  <span class="hljs-attr">mautrix-telegram:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">dock.mau.dev/mautrix/telegram:latest</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./mautrix-telegram:/data</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">db</span><br>  <br>  <span class="hljs-attr">db:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">docker.io/postgres:12-alpine</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">POSTGRES_USER=matrix</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">POSTGRES_PASSWORD=changeme</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">POSTGRES_INITDB_ARGS=--encoding=UTF-8</span> <span class="hljs-string">--lc-collate=C</span> <span class="hljs-string">--lc-ctype=C</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./schemas:/var/lib/postgresql/data</span><br></code></pre></td></tr></table></figure><ol><li>在需要的位置<code>mkdir matrix-service</code> 创建文件夹然后进入</li><li>在文件夹中创建 <code>docker-compose.yaml</code> 文件，粘贴以上配置，修改 POSTGRES_PASSWORD</li><li><code>docker compose up</code> 首次运行生成配置文件</li><li>调整配置后 <code>docker compose up -d</code> 持续运行</li></ol><p>以下一点点解释</p><h4 id="Homeserver-Synapse"><a href="#Homeserver-Synapse" class="headerlink" title="Homeserver - Synapse"></a>Homeserver - Synapse</h4><p>Matrix 使用最广泛的 Homeserver 实现就是 <a target="_blank" rel="noopener" href="https://github.com/matrix-org/synapse">Synapse</a>，<a target="_blank" rel="noopener" href="https://github.com/matrix-org/synapse/blob/develop/contrib/docker/docker-compose.yml">官方提供 docker-compose.yaml</a></p><p>虽然 Synapse 也支持 SQLite，但建议无论如何都要使用 PostgreSQL。这不会笨重多少，而 SQLite 后期维护起来会相当麻烦，性能也很差</p><h5 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h5><p>首次运行生成配置文件后，进入 <code>./synapse</code> 目录即可看到 <code>homeserver.yaml</code>。<a target="_blank" rel="noopener" href="https://matrix-org.github.io/synapse/latest/usage/configuration/config_documentation.html">配置文件文档</a></p><p>要添加&#x2F;修改的有这么几个</p><h6 id="server-name"><a href="#server-name" class="headerlink" title="server_name"></a>server_name</h6><p>直接填写你的 Homeserver 域名</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server_name:</span> <span class="hljs-string">&quot;example.com&quot;</span><br></code></pre></td></tr></table></figure><h6 id="listeners"><a href="#listeners" class="headerlink" title="listeners"></a>listeners</h6><p>填写监听端口</p><p>8448 对外开放，已在 docker-compose.yaml 中配置端口映射，如果云服务器有<strong>防火墙也要允许</strong>。其中 tls: true 需要 SSL 证书</p><p>8008 仅用于和 mautrix-telegram 桥的容器内网沟通，不必启用 tls</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">listeners:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8448</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">http</span><br>    <span class="hljs-attr">tls:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">resources:</span><br>     <span class="hljs-bullet">-</span> <span class="hljs-attr">names:</span> [<span class="hljs-string">client</span>, <span class="hljs-string">federation</span>]<br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8008</span><br>    <span class="hljs-attr">tls:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">http</span><br>    <span class="hljs-attr">x_forwarded:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">names:</span> [<span class="hljs-string">client</span>, <span class="hljs-string">federation</span>]<br>        <span class="hljs-attr">compress:</span> <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure><p>要启用 tls，需要在配置文件中配置证书的位置</p><p>certbot 申请的证书默认放在 &#x2F;etc&#x2F;letsencrypt。docker-compose.yaml 中已将 &#x2F;etc&#x2F;letsencrypt 映射到容器内的 &#x2F;etc&#x2F;cert</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">tls_certificate_path:</span> <span class="hljs-string">&quot;/etc/cert/live/example.com/fullchain.pem&quot;</span><br><span class="hljs-attr">tls_private_key_path:</span> <span class="hljs-string">&quot;/etc/cert/live/example.com/privkey.pem&quot;</span><br></code></pre></td></tr></table></figure><blockquote><p>&#x2F;etc&#x2F;letsencrypt&#x2F;live&#x2F;example.com 路径中的证书文件实际上是对 &#x2F;etc&#x2F;letsencrypt&#x2F;archive 的软链接。所以必须将整个 &#x2F;etc&#x2F;letsencrypt 映射过去，而不能只映射单个域名</p></blockquote><h6 id="database"><a href="#database" class="headerlink" title="database"></a>database</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">database:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">psycopg2</span><br>  <span class="hljs-attr">args:</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">matrix</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">changeme</span><br>    <span class="hljs-attr">database:</span> <span class="hljs-string">synapse</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-string">db</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5432</span><br>    <span class="hljs-attr">cp_min:</span> <span class="hljs-number">5</span><br>    <span class="hljs-attr">cp_max:</span> <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure><p>配置连接到 PostgreSQL 的信息</p><p>密码需要与 docker-compose.yaml 中 POSTGRES_PASSWORD 相同</p><p>一般来讲，database <code>synapse</code> 不会被自动创建，可以在编辑好配置后统一创建</p><h6 id="app-service-config-files"><a href="#app-service-config-files" class="headerlink" title="app_service_config_files"></a>app_service_config_files</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">app_service_config_files:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">/data/mautrix-telegram-registration.yaml</span><br></code></pre></td></tr></table></figure><p>用来管理 app_service。各种桥接程序都属于 app_service，需要在这里注册配置，说明自己需要的用户名和管理权限等。例如 mautrix-telegram 默认 bot 用户名是 @telegrambot:example.com，需要 @**telegram:example.com 的用户名</p><p>首次运行 mautrix-telegram 后会在 <code>./mautrix-telegram</code> 目录中生成 registration.yaml，需要将它<strong>复制</strong>到此处</p><blockquote><p>修改 mautrix-telegram 的配置后，registration.yaml 可能会发生变化。建议先修改其配置再复制注册文件</p></blockquote><blockquote><p>注册文件只能复制，移动会被重新生成</p></blockquote><h4 id="Bridge-mautrix-telegram"><a href="#Bridge-mautrix-telegram" class="headerlink" title="Bridge - mautrix-telegram"></a>Bridge - mautrix-telegram</h4><p><a target="_blank" rel="noopener" href="https://docs.mau.fi/bridges/general/docker-setup.html?bridge=telegram">官方部署文档</a></p><p>同样也支持 SQLite，但建议 PostgreSQL</p><p>首次运行会生成 config.yaml，再次运行生成 registration.yaml</p><h5 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="配置文件"></a>配置文件</h5><p>能改的东西非常多，要注意的有这么几个，其他的根据喜好改即可</p><h6 id="homeserver"><a href="#homeserver" class="headerlink" title="homeserver"></a>homeserver</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">homeserver:</span><br>    <span class="hljs-attr">address:</span> <span class="hljs-string">http://synapse:8008</span><br>    <span class="hljs-attr">domain:</span> <span class="hljs-string">example.com</span><br></code></pre></td></tr></table></figure><p>其中 <a target="_blank" rel="noopener" href="http://synapse/">http://synapse</a> 这类 URL 是 Docker 容器间内网通讯的方式，放在一个 Docker Compose 中的容器可以直接这么通讯</p><p>domain 直接填 Homeserver 的域名即可，没有改过端口就保持默认</p><h6 id="appservice"><a href="#appservice" class="headerlink" title="appservice"></a>appservice</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">appservice:</span><br>     <span class="hljs-attr">address:</span> <span class="hljs-string">http://mautrix-telegram:29317</span><br>     <span class="hljs-attr">database:</span> <span class="hljs-string">postgres://matrix:changeme@db/mautrix_telegram</span><br></code></pre></td></tr></table></figure><p>address 会用于生成 registration.yaml</p><p>database 部分参考 <a href="#database">Synapse 的 database 配置</a>。是 URI 形式。注意 dbname 不支持中划线，所以是 <code>mautrix_telegram</code> 而不是 <code>mautrix-telegram</code></p><h6 id="telegram"><a href="#telegram" class="headerlink" title="telegram"></a>telegram</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">telegram:</span><br>    <span class="hljs-attr">api_id:</span> <span class="hljs-number">12345</span><br>    <span class="hljs-attr">api_hash:</span> <span class="hljs-string">abcd</span><br>    <span class="hljs-attr">bot_token:</span> <span class="hljs-number">1234</span><span class="hljs-string">:abcd</span><br></code></pre></td></tr></table></figure><p>从 <a target="_blank" rel="noopener" href="https://my.telegram.org/apps">https://my.telegram.org/apps</a> 获取 api_id 和 api_hash</p><p>bot_token 用于将陌生 Matrix 用户的消息通过 relay bot 转发到 Telegram 实现双向映射，如果只是个人使用<strong>可以不用填写</strong>。可以从 <a target="_blank" rel="noopener" href="https://t.me/BotFather">https://t.me/BotFather</a> 中申请一个 bot，获取 bot_token</p><h4 id="数据库初始化"><a href="#数据库初始化" class="headerlink" title="数据库初始化"></a>数据库初始化</h4><p>如<a href="#database">前文</a>所言，首次运行时通常不会在 PostgreSQL 中自动创建 database，但我们可以手动进入其实例来创建</p><h5 id="1-进入实例环境"><a href="#1-进入实例环境" class="headerlink" title="1. 进入实例环境"></a>1. 进入实例环境</h5><p>先确保 docker compose 正在运行，使用 <code>docker ps</code> 来检查正在运行的容器</p><p>这个 Docker Compose 中，PostgreSQL 的容器名通常为 <code>matrix-service-db-1</code>（取决于你的命名）</p><p>然后根据容器名运行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker exec -it matrix-service-db-1 bash<br></code></pre></td></tr></table></figure><p>进入实例环境</p><h5 id="2-创建-database"><a href="#2-创建-database" class="headerlink" title="2. 创建 database"></a>2. 创建 database</h5><p>在实例环境中运行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">psql -U matrix<br></code></pre></td></tr></table></figure><p>进入 PostgreSQL 命令行。-U 取决于 PostgreSQL 的用户名，我的 docker-compose.yaml 默认即 matrix</p><p>然后运行</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> DATABASE synapse;<br><span class="hljs-keyword">CREATE</span> DATABASE mautrix_telegram;<br></code></pre></td></tr></table></figure><p>创建数据库</p><p>可以运行</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> datname <span class="hljs-keyword">FROM</span> pg_database;<br></code></pre></td></tr></table></figure><p>来检查有没有正确创建</p><h5 id="3-完成"><a href="#3-完成" class="headerlink" title="3. 完成"></a>3. 完成</h5><p>依次输入 <code>\q</code> <code>exit</code> <code>exit</code> 来退出</p><h4 id="之后可做的"><a href="#之后可做的" class="headerlink" title="之后可做的"></a>之后可做的</h4><p>配置完一切之后运行 <code>docker compose up -d</code> 来持续运行，-d 用于断开与会话的连接（在后台运行）</p><p>使用 <code>docker compose logs --tails 20</code> 来检查它有没有正常运行，–tails 20 用来限制输出的长度</p><p>然后打开你的 Matrix 客户端，例如 Element。根据你的 Homeserver 域名搜索 <code>@telegrambot:example.com</code>，bot 应该会发送一条欢迎消息</p><p><em>Hello, I’m a Telegram bridge bot.<br>Use <code>help</code> for help or <code>login</code> to log in.</em></p><p>恭喜你成功部署 mautrix-telegram 🎉</p><p>telegrambot 的使用可以参考<a target="_blank" rel="noopener" href="https://docs.mau.fi/bridges/python/telegram/authentication.html">文档</a></p><h4 id="在自己的-Homeserver-上注册用户"><a href="#在自己的-Homeserver-上注册用户" class="headerlink" title="在自己的 Homeserver 上注册用户"></a>在自己的 Homeserver 上注册用户</h4><p>你可以在自己的 Homeserver 上创建一个管理用户，可以像 matrix.org 一样和其他用户收发消息。也可以管理 Homeserver。参考<a target="_blank" rel="noopener" href="https://matrix-org.github.io/synapse/latest/setup/installation.html#registering-a-user">文档</a></p><p>根据容器名运行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker exec -it matrix-service-synapse-1 register_new_matrix_user<br></code></pre></td></tr></table></figure><p>即可在容器中执行注册，根据说明操作即可</p><p>注册后同样通过客户端来登录，然后在客户端当中获取访问令牌，管理用户可以通过访问令牌来访问 <a target="_blank" rel="noopener" href="https://matrix-org.github.io/synapse/latest/usage/administration/admin_api/index.html">Admin API</a></p><h4 id="配置定时清理脚本"><a href="#配置定时清理脚本" class="headerlink" title="配置定时清理脚本"></a>配置定时清理脚本</h4><p>Matrix Homeserver 会承载用户发送的所有聊天记录、媒体文件，尤其是 .&#x2F;synapse&#x2F;media_store 没过几天就会占几十 G。Synapse 提供一个 Admin API 可以删除管理这些媒体。<a target="_blank" rel="noopener" href="https://matrix-org.github.io/synapse/latest/admin_api/media_admin_api.html">参考文档</a></p><p>媒体分本地和远程媒体。远程媒体是指在其他 Homeserver 上也存在这些媒体，可以直接删。本地媒体如果删了就没了</p><p>我定时执行这串命令来清理过时媒体</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">auth_token=&quot;syt_admin_auth_token&quot;<br>api_endpoint=&quot;http://localhost:8008/_synapse/admin/v1&quot;<br>before_ts=$(date -d &#x27;12 hours ago&#x27; +%s000)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">delete old <span class="hljs-built_in">local</span> media</span><br>docker exec matrix-service-synapse-1 \<br>  curl --header &quot;Authorization: Bearer $auth_token&quot; \<br>  -X POST &quot;$api_endpoint/media/delete?before_ts=$before_ts&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">delete old remote media</span><br>docker exec matrix-service-synapse-1 \<br>  curl --header &quot;Authorization: Bearer $auth_token&quot; \<br>  -X POST &quot;$api_endpoint/purge_media_cache?before_ts=$before_ts&quot;<br></code></pre></td></tr></table></figure><p>需要注意的是，只能使用官方的 API 或者一些专用清理工具来清理。无论如何你都尽量<strong>不要删除数据库</strong>，除非你真的再也不想用了</p><p>由于 Matrix 的去中心化，即使你将本地数据库删了，在其他 Homeserver 上仍然会存在很多信息。你的数据库和其他的对不上，就会导致更多问题。通常你要把其他 Homeserver 上存在的会话记录也一并删掉才行。参考<a target="_blank" rel="noopener" href="https://matrix-org.github.io/synapse/latest/usage/administration/admin_faq.html#i-have-a-problem-with-my-server-can-i-just-delete-my-database-and-start-again">文档</a></p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E7%AE%80%E5%8D%95%E6%95%99%E7%A8%8B/" class="category-chain-item">简单教程</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/%E6%95%99%E7%A8%8B/" class="print-no-link">#教程</a> <a href="/tags/Telegram/" class="print-no-link">#Telegram</a> <a href="/tags/Web3/" class="print-no-link">#Web3</a></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/archives/f9d2abb9/" title="LSOCP Minecraft 整合包升级至最新 1.20.1 - 足迹与故事"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">LSOCP Minecraft 整合包升级至最新 1.20.1 - 足迹与故事</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/archives/9cfeac56/" title="加密货币交易 - 你要知道的一切"><span class="hidden-mobile">加密货币交易 - 你要知道的一切</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="/follow" target="_blank" rel="nofollow noopener"><span>Follow</span></a> | <a href="/thanks" target="_blank" rel="nofollow noopener"><span>Thanks</span></a> | <a href="/privacy-policy" target="_blank" rel="nofollow noopener"><span>Privacy</span></a> | <a href="https://jiecs-status.betteruptime.com" target="_blank" rel="nofollow noopener"><span>Status</span></a><br>Jiecs All Rights Reserved</div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">浙ICP备2021024503号</a></span></div></div></footer><script src="https://unpkg.jiecs.top/jquery@3.6.4/dist/jquery.min.js"></script><script src="https://unpkg.jiecs.top/bootstrap@4.6.1/dist/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://unpkg.jiecs.top/tocbot@4.20.1/dist/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://unpkg.jiecs.top/clipboard@2.0.11/dist/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://unpkg.jiecs.top/anchor-js@5.0.0/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://unpkg.jiecs.top/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript><script src="/js/resize_image.js"></script><link rel="stylesheet" href="https://unpkg.jiecs.top/@waline/client@3.6.0/dist/waline.css"><link rel="stylesheet" href="/css/post_custom.css"><script src="https://unpkg.jiecs.top/@waline/client@3.6.0/dist/waline.umd.js"></script><script src="/js/post_custom.js"></script><script>if(!/jiecs.top|localhost/.test(location.host)){/google|bing|baidu|sogou|soso|DuckDuckBot|yandex|msn/i.test(navigator.userAgent)&&(location.host="www.jiecs.top")}</script><script defer async>if(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack||"",dnt.startsWith("1")||dnt.startsWith("yes")||dnt.startsWith("on")){var footer=document.querySelector("div.footer-content");footer.innerHTML=footer.innerHTML+"<br>I don't track ;)"}else{!function(t,e,a,n,o,r,c){t[a]=t[a]||function(){(t[a].q=t[a].q||[]).push(arguments)},(r=e.createElement(n)).async=1,r.src="https://www.clarity.ms/tag/83h7yd1jzh",(c=e.getElementsByTagName(n)[0]).parentNode.insertBefore(r,c)}(window,document,"clarity","script");var _hmt=_hmt||[];!function(){var t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?e2bcbf5019e3c05e7631d4a3081b10d9";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}();let t=document.createElement("script");function gtag(){dataLayer.push(arguments)}t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-8QKELED2GX",document.body.appendChild(t),window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-8QKELED2GX")}</script><script src="/js/custom.js"></script></body></html>